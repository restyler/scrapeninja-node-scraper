<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!--<script src="
https://cdn.jsdelivr.net/npm/vue-json-tree-view@2.1.6/dist/vue-json-tree-view.min.js
"></script>-->
    <script src="https://unpkg.com/vue-json-viewer@2.1.4/vue-json-viewer.js"> </script>
    <link href="https://unpkg.com/vue-json-viewer@2.1.4/style.css" rel="stylesheet">


    <title>Web Scraper UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>

<body>
    <style>
        .item-service-info-container {
            font-size: 0.8rem;
            color: #888;
        }

        .item-list-enter-active,
        .item-list-leave-active {
            transition: background 2s ease;
            background-color: white;
        }

        .item-list-enter,
        .item-list-leave-to {
            background-color: yellow;
        }
    </style>
    <div id="app" class="container-fluid"> <!-- Bootstrap fluid container -->
        <h1 class="mt-4">Web Scraper Runner</h1>
        <div class="d-flex mt-4 mb-4"> <!-- Flexbox to position buttons -->
            <button class="btn btn-primary me-2" @click="startProcess">Start Process</button>
            <button class="btn btn-danger" @click="stopProcess">Stop Process</button>
        </div>

        <h3 v-if="logs.length">Logs:</h3>
        <div class="mb-4 overflow-auto" style="max-height: 500px;" v-if="logs.length" ref="logsContainer" >
            <div v-for="log in logs" :key="log.id"> 
                {{ log.message }}
            </div>
        </div>

        <div v-if="errors.length">
            <h3>Errors:</h3>
            <div v-for="error in errors" class="text-danger alert alert-danger" role="alert" :key="error.id">
                {{ error.message }}
            </div>
        </div>

        <div class="mt-4 mb-4">
            <button class="btn btn-info" @click="showForm = !showForm">Add more items</button>
            <div v-if="showForm">
                <textarea v-model="newItems" class="form-control mt-2" rows="5" placeholder="Enter URLs, one per line"></textarea>
                <button class="btn btn-success mt-2" @click="submitItems">Submit</button>
            </div>
        </div>


        <div class="mt-4 mb-4">
            <h3>Items ({{ totalItems }}). <span style="font-size: 0.5em; color: #999">Last refreshed: {{ lastRefreshSecondsAgo }}s ago</span></h3>
            
            <div v-for="item in items" :key="item.id" class="border-bottom p-2">
                <!-- First Line: Display URL -->
                <div class="d-flex mb-2">
                    <div class="flex-fill">URL: {{ item.url }} 
                        <div v-if="item.ep1FinishedAt" class="badge bg-success">FINISHED</div>
                        <div v-else-if="item.ep1ErrorAt" class="badge bg-danger">ERROR</div>
                    </div>
                    <div>
                        <button @click="openModal(item)" class="btn btn-info btn-sm">View Details</button>
                    </div>
                </div>
            
                <!-- Second Line: Display Timestamps and Error Details -->
                <div class="d-flex item-service-info-container">
                    
                    <div class="flex-fill">ID: #{{item.id}}. Created At: {{ item.createdAt }}</div>
                    <div v-if="item.ep1StartedAt" class="flex-fill">EP1 Started At: {{ item.ep1StartedAt }}</div>
                    <div v-if="item.ep1FinishedAt" class="flex-fill">EP1 Finished At: {{ item.ep1FinishedAt }}</div>
                    
                    
                </div>

                <!-- Third line: Errors -->
                <div v-if="item.ep1ErrorMsg" class="item-service-info-container">
                    <div class="flex-fill">EP1 Error Count: {{ item.ep1ErrorCount }}</div>
                    <div class="flex-fill text-danger">EP1 Error Message: {{ item.ep1ErrorMsg }}</div>
                    <div v-if="item.ep1ErrorAt" class="flex-fill">EP1 Error At: {{ item.ep1ErrorAt }}</div>
                </div>
            </div>
            
            
            
        
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination">
                    <li class="page-item" :class="{ 'disabled': currentPage == 1 }">
                        <button class="page-link" @click="changePage(currentPage - 1)">Previous</button>
                    </li>
                    <li class="page-item" v-for="page in totalPages" :key="page" :class="{ 'active': page == currentPage }">
                        <button class="page-link" @click="changePage(page)">{{ page }}</button>
                    </li>
                    <li class="page-item" :class="{ 'disabled': currentPage == totalPages }">
                        <button class="page-link" @click="changePage(currentPage + 1)">Next</button>
                    </li>
                </ul>
            </nav>
        </div>




        <!-- Modal -->
        <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div><strong>URL:</strong> {{ currentItem.url }}</div>
                    <div><strong>Data:</strong> 
                        
                        <!--<tree-view :data="currentItem.data" :options="{maxDepth: 3}"></tree-view>-->
                        <div v-if="currentItem && loadingData" class="spinner-border text-primary" role="status">
                            <span class="sr-only"></span>
                        </div>
                        <json-viewer v-if="currentItem && currentItem.data" :value="currentItem.data" :search="true" /></div>
                    <div><strong>Created At:</strong> {{ currentItem.createdAt }}</div>
                    <div><strong>EP1 Started At:</strong> {{ currentItem.ep1StartedAt }}</div>
                    <div><strong>EP1 Finished At:</strong> {{ currentItem.ep1FinishedAt }}</div>
                    <div><strong>EP1 Error At:</strong> {{ currentItem.ep1ErrorAt }}</div>
                    <div><strong>EP1 Error Message:</strong> {{ currentItem.ep1ErrorMsg }}</div>
                    <div><strong>EP1 Error Count:</strong> {{ currentItem.ep1ErrorCount }}</div>
                        
                    <h3 class="mt-4">Logs:</h3>
                    <div class="mb-4 overflow-auto" style="max-height: 500px;" v-if="currentItem.logs && currentItem.logs.length"  >
                        <div v-for="log in currentItem.logs" :key="log.id" :class="{ 'text-danger': log.severity == 'error' }">
                            {{ log.createdAt }} [{{ log.severity }}]:
                            {{ log.message }}
                        </div>
                    </div>
                </div>

                    

                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
        


    </div>

    <script src="/static/app.js?g"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>


</body>

</html>
